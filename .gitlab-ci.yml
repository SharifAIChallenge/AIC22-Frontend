stages:
  - build
  - deploy-production

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED == "false"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "test"'
      when: always
    - when: never

variables:
  IMAGE_URL: reg.aichallenge.ir/aic22-frontend:stg 

build:
  stage: build
  image: reg.aichallenge.ir/docker:19.03.12
  tags:
    - docker
  script:
    - docker build . -t $IMAGE_URL
    - docker push $IMAGE_URL


deploy-production:
  stage: deploy-production
  image: kroniak/ssh-client:latest
  before_script:
    - chmod -R 700 $SSH_PRIVATE_KEY
  # script:
  #   - ssh -i $SSH_PRIVATE_KEY -o "StrictHostKeyChecking=no" ubuntu@188.121.111.163 -t "docker rm -f aic_frontend && docker pull $IMAGE_URL && docker run -d -p 127.0.0.1:3001:80 --name=aic_frontend $IMAGE_URL"
